<!doctype html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Mastodon Archive Visualizer powered by d3.js</title>
		<link rel="icon" href="favicon.ico" id="favicon">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.0/nouislider.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
		<style>
			/* Body */
				body{
					width:100%;
					text-align:center;
					overflow-y:scroll;
					height:100%;
					margin:0;
				}
				#dropArea {
					position: absolute;
					left: 0;
					top:0;
					width: 100%;
					height: 150vh;
					padding: 0;
					margin:	0;
					transition: all 0.25s cubic-bezier(0.21, 0.51, 0.51, 1);
				}
				#dropArea.dragover {
					background: #16a5bf;
				}
			/* Header */
				div#header{
					position:sticky;
					top:0;
					vertical-align: middle;
					background-color: #fff;
					z-index: 2;
				}
				#progress{
					margin:0;
				}
				#slider{
					width:80%;
					margin:10px auto 30px;
					display:inline-block;
					height:5px;
					border:none;
				}
				.noUi-pips{
					margin:0;
					height:30px;
					padding:0;
				}
				#slider .noUi-connect {
					background: #00ada9;
				}
				#slider .noUi-handle {
					height: 18px;
					width: 18px;
					top: -5px;
					right: -9px; /* half the width */
					border-radius: 9px;
					border:2px solid #000;
					background-color: #000;
					box-shadow: none;
				}
				#slider .noUi-handle::before,
				#slider .noUi-handle::after{
					display:none;
				}
				#slider .noUi-marker{
					background:#000;
				}
				.noUi-marker-horizontal.noUi-marker{
					width:1px;
				}
				#header input[type=text]{
					width:100px;
					text-align: center;
				}
				#range p{
					margin:0;
				}
				.wrapper{
					display: inline-block;
					margin:0 10px;
				}
				#range .wrapper p{
					margin: 10px 10px 5px;
				}
				input[type=radio],input[type=checkbox]{
					display:none;
				}
				div.palette{
					border:solid 2px #bbb;
					border-radius: 10px;
					position: relative;
					margin-bottom: 10px;
				}
				.palette .title{
					position: absolute;
					display: inline-block;
					top: -0.5em;
					left: 20px;
					padding: 0 9px;
					line-height: 1;
					background-color: #fff;
					font-weight: bold;
				}
				em,#b_slider {
					display:inline-block;
					width:70px;
					background-color:#2ec5f0;
					color:#fff;
					vertical-align: middle;
					text-align:center;
					font-size:12px;
					font-weight: bold;
					font-style: normal;
					border:solid 2px #2ec5f0;
					border-radius: 10px;
					padding: 5px 0;
					margin: 1px;
				}
				#b_slider:hover {
					background-color: #00ada9;
					border-width: 4px;
				}
				em:hover {
					background-color: #00ada9;
					border-width: 4px;
				}
				input:checked + em{
					background-color: #fff;
					color:#2ec5f0;
					border-width: 3px;
					font-style: italic;
				}
				#b_open{
					height:20px;
					margin-bottom:0;
					margin-top:0;
					width:100%;
					border:none;
				}
			/* Load */
				#load{
					position: relative;
					font-family:"arial unicode ms";
					font-size:14px;
					margin-top:10px;
					margin-left:auto;
					margin-right:auto;
					text-align:center;
					border-radius:5px;
				}
				#load span{
					position: relative;
					display: inline-block;
					border: 1px solid #333;
					border-radius: 4px;
					background: #333;
					padding:27px;
					color: #fff;
					font-size: 26px;
					line-height: 1;
					font-weight: bold;
					vertical-align: middle;
				}
				#load input[type=file]{
					position:absolute;
					z-index: 1;
					display: block;
					width: 288px;
					height: 80px;
					opacity: 0;
					bottom:0;
					left:0;
				}
			/* Main */
				div#main{
					width:80%;
					margin-left:auto;
					margin-right:auto;
					padding-top:0;
				}
			/* Summary */
			/* Figure */
				#map{
					margin:10px;
				}
			/* Search */
				#search input[type=search]{
					width:145px;
					font-weight: bold;
					font-size: 20px;
					display: block;
				}
				#search{
					display:flex;
					flex-direction:row;
					justify-content:space-evenly;
				}
				table{
					/* table-layout:fixed; */
					/* display:inline-block; */
					font-weight:normal;
					margin-left:auto;
					margin-right:auto;
				}
				td,th{
					padding:0;
				}
				.date{
					width:150px;
					text-align: center;
				}
				.content{
					word-break:break-word;
				}
				.content a{
					color:black;
				}
				a{
					position: relative;
					z-index:1;
				}
			/* Manager */
				#manager{
					display:inline-block;
				}
				button.manager{
					width:80px;
					padding:10px 0;
					border-radius:5px;
					border:solid 3px #2ec5f0;
					font-weight: bold;
					color:#fff;
					background-color: #2ec5f0;
					margin:10px 0;
				}
				button.manager:hover {
					background-color: #00ada9;
					border-width: 4px;
				}
			/* Footer */
				div#footer{
					margin:10px auto;
					font-size:14px;
					width:600px;
					border-radius:5px;
					text-align: left;
				}
		</style>
	</head>
	<body onload="getSample();">
		<div id=dropArea></div>
		<div id=header>
			<div class="progress" id=progress style="display:none;">
				<div class="indeterminate"></div>
			</div>
			<div id=range>
				<div id="slider"></div>
				<p>
					<input class=txtbox type=text placeholder=YYYY-MM-DD id=range_since onChange="button(this);">
					<span> -- </span>
					<input class=txtbox type=text placeholder=YYYY-MM-DD id=range_until onChange="button(this);">
					<span>	</span>
					<button id=b_slider onclick="button(this);">Full</button><br>
				</p>
				<div class=wrapper>
					<div class=palette id=visi_palette>
						<b class=title>Visibility</b>
						<p>
							<label id=visi_public	><input onclick="button(this);" type=checkbox name=visi id=v_public checked=checked><em>Public</em></label>
							<label id=visi_unlisted ><input onclick="button(this);" type=checkbox name=visi id=v_unlisted checked=checked><em>Unlisted</em></label>
							<label id=visi_private	><input onclick="button(this);" type=checkbox name=visi id=v_private checked=checked><em>Private</em></label>
							<label id=visi_direct	><input onclick="button(this);" type=checkbox name=visi id=v_direct checked=checked><em>Direct</em></label>
							<label id=visi_boost	><input onclick="button(this);" type=checkbox name=visi id=v_boost checked=checked><em>Boost</em></label>
							<label id=visi_like		><input onclick="button(this);" type=checkbox name=visi id=v_like checked=checked><em>Like</em></label>
						</p>
					</div>
				</div>
			</div>
			<button id=b_open href="#header" onclick="button(this);"></button>
		</div>
		<p id=load>.tar.gzファイルを解凍してその中のoutbox.jsonとlikes.jsonをドロップしてください。<br>
			または<br>
			<span><input type=file multiple=multiple accept=".json" onchange="loadFile(this.files);">ファイルを選択する</span>
		</p>
		<div id=main>
			<p id=db_since_until>Got 10000 toots, since 2009-11-11 until 2021-12-18.</p>
			<p id=up_count_ratio>You used Mastodon 123/311 days (30.33%), and toot 109 times per day.</p>
			<p id=visibility_ratio>0.23% in Public, 93.12% in Unlisted, 1.23% in Private, 3.86% in Direct, 5.21% in Boost.</p>
			<p id=posts_reply_count>Toot:32768 times, Reply:1280 times, Boost:2121 times, Favourite:12768 times</p>
			<div class=wrapper>
				<div class=palette id=data_palette>
					<b class=title>Data</b>
					<p>
						<label id=data_post	 	><input onclick="button(this);" type=radio name=data id=d_post checked=checked><em>Own Posts</em></label>
						<label id=data_mention	><input onclick="button(this);" type=radio name=data id=d_mention><em>Mention</em></label>
						<label id=data_reblog	><input onclick="button(this);" type=radio name=data id=d_reblog><em>Reblog</em></label>
						<label id=data_like	 	><input onclick="button(this);" type=radio name=data id=d_like><em>Favourite</em></label>
						<label id=data_search	><input onclick="button(this);" type=radio name=data id=d_search><em>Search</em></label>
					</p>
				</div>
				<div class=palette id=type_palette>
					<b class=title>Type</b>
					<p>
						<label id=type_bar		><input onclick="button(this);" type=radio name=type id=t_bar checked=checked><em>Bar Plot</em></label>
						<label id=type_horizon	><input onclick="button(this);" type=radio name=type id=t_horizon><em>Horizon</em></label>
						<label id=type_calendar ><input onclick="button(this);" type=radio name=type id=t_calendar><em>Calendar</em></label>
						<label id=type_line	 	><input onclick="button(this);" type=radio name=type id=t_line><em>Line Plot</em></label>
					</p>
				</div>
				<div class=palette id=stack_palette>
					<b class=title>Stack</b>
					<p>
						<label id=stack_day	 	><input onclick="button(this);" type=radio name=stack id=s_day><em>Day</em></label>
						<label id=stack_week	><input onclick="button(this);" type=radio name=stack id=s_week><em>Week</em></label>
						<label id=stack_month	><input onclick="button(this);" type=radio name=stack id=s_month><em>Month</em></label>
						<label id=stack_year	><input onclick="button(this);" type=radio name=stack id=s_year><em>Year</em></label>
						<label id=stack_none	><input onclick="button(this);" type=radio name=stack id=s_none checked=checked><em>None</em></label>
					</p>
				</div>
				<div class=palette id=reso_palette>
					<b class=title>Resolution</b>
					<p>
						<label id=reso_minute	><input onclick="button(this);" type=radio name=reso id=r_minute><em>1 Mnt</em></label>
						<label id=reso_minutes	><input onclick="button(this);" type=radio name=reso id=r_minutes><em>10 Mnts</em></label>
						<label id=reso_hour	 	><input onclick="button(this);" type=radio name=reso id=r_hour><em>1 Hour</em></label>
						<label id=reso_hours	><input onclick="button(this);" type=radio name=reso id=r_hours><em>2 Hrs</em></label>
						<label id=reso_day		><input onclick="button(this);" type=radio name=reso id=r_day checked=checked><em>Day</em></label>
						<label id=reso_week	 	><input onclick="button(this);" type=radio name=reso id=r_week><em>Week</em></label>
						<label id=reso_month	><input onclick="button(this);" type=radio name=reso id=r_month><em>Month</em></label>
						<label id=reso_full	 	><input onclick="button(this);" type=radio name=reso id=r_full><em>Full</em></label>
					</p>
				</div>
				<div class=palette id=cumu_palette>
					<b class=title>Cumulative</b>
					<p>
						<label id=cumu_cumulative	><input onclick="button(this);" type=radio name=cumu id=c_cumulative checked=checked><em>Cumulative</em></label>
						<label id=cumu_density 		><input onclick="button(this);" type=radio name=cumu id=c_density><em>Density</em></label>
					</p>
				</div>
			</div>
		</div>
		<div id=map></div>
			<div id=search>
				<input placeholder="Word" type=search id=word onChange="dataSearch(this);">
				<input placeholder="YYYY-MM-DD" type=search id=date onChange="dataSearch(this);">
				<input placeholder="Account" type=search id=account onChange="dataSearch(this);">
			</div>
			<p id=request></p>
			<div class=wrapper>
				<table id=result></table>
			</div>
			<div class=wrapper>
				<table id=manager cellspacing=10>
					<tr id=createSample>
						<td>データを上書き保存します。</td>
						<td><button class=manager onclick="createSample();">Save</button></td>
					</tr>
					<tr>
						<td>データをまたこのサイトで使えるjsonファイルとしてダウンロードします。</td>
						<td><button class=manager onclick="downloadJson();">Download</button></td>
					</tr>
					<tr id=deleteSample>
						<td>データベースを削除します。削除する前にデータをダウンロードすることをおすすめします。</td>
						<td><button class=manager onclick="deleteSample();">Clear</button></td>
					</tr>
				</table>
			</div>
		</div>
		<div id=footer>
			<p>圧縮ファイルを解凍するのは<a target="_blank" href="https://sevenzip.osdn.jp/">7zip</a>などで。</p>
			<p>全てJavaScriptで処理されているため、サーバーにデータは保存されません。</p>
			<p>クライアントサイドでブラウザに付属したデータベースを利用することが可能で、<br>
				その場合は再アクセス後自動的にデータを読み込みます。そのデータの管理はData Managerから行ってください。</p>
			<p>ページを更新するとファイル選択画面に戻ります。ファイルを間違えた場合はページを更新してください。</p>
			<p>Chromeのみで動作確認しています。不具合、要望等ありましたらお気軽にご連絡ください。</p>
			<p>ソースコード:<a target="_blank" href="https://github.com/onekodate/mastodon">Github</a>
				開発者:<a target="_blank" href="https://mstdn.beer/web/accounts/80060">@onekodate@mstdn.beer</a></p>
			<p>参考:<a target="_blank" href="https://github.com/yuzulabo/Mastodon-Archive-Viewer">nzwsさんによるMastodon-Archive-Viewer</a></p>
			<a id="downloadLink"></a>
		</div>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.0/nouislider.min.js"></script>
		<script src="https://d3js.org/d3.v7.js"></script>
		<script>
/* Declaration */
	const data={
		json:{},
		raw:{
			outbox:[],
			likes:[],
		},
		full:[],
		range:[],
		search:[],
		plot:[],
		reso:[],
		bar:[],
		bool:{
			outbox:false,
			likes:false,
		},
	};
	const range={
		full:[],
		select:[],
		slider:[],
	};
	const plot={
		data:"post",
		type:"bar",
		stack:"none",
		reso:"day",
		cumu:true,
		visibility:["public","unlisted","private","direct","boost","like"],
		bar:null,
		width:1000,
		search:{
			id:"",
			value:"",
		},
	};
	const metroColors=["#f39700","#e60012","#9caeb7","#00a7db","#009944","#d7c447","#9b7cb6","#00ada9","#bb641d"];
/* Basic Function */
	const elem		= (id)=>document.getElementById(id);
	const date2str	= (date)=>date
		?`${date.getFullYear()}-${date.getMonth()<9?"0":""}${date.getMonth()+1}-${date.getDate()<10?"0":""}${date.getDate()}`
		:"";
	const time2str	= (date)=>date
		?`${date2str(date)} ${date.getHours()<10?"0":""}${date.getHours()}:${date.getMinutes()<10?"0":""}${date.getMinutes()}:${date.getSeconds()<10?"0":""}${date.getSeconds()}`
		:"";
/* Loading */
	const fileArea	= elem("dropArea");
		fileArea.addEventListener("dragover",(e)=>{
			e.preventDefault();
			fileArea.classList.add("dragover");
		});
		fileArea.addEventListener("dragleave",(e)=>{
			e.preventDefault();
			fileArea.classList.remove("dragover");
		});
		fileArea.addEventListener("drop",(e)=>{
			e.preventDefault();
			fileArea.classList.remove("dragover");
			loadFile(e.dataTransfer.files);
		});
	const loadFile	= (files)=>{
		for(const file of files){
			elem("progress").style.display="block";
			if(file.type==="application/json"){
				const reader	= new FileReader();
				reader.onload	= (event)=>{
					data.json	= JSON.parse(event.target.result);
					if(data.json.id==="outbox.json"){
						console.log("Outbox Start");
						const start	= performance.now();
						data.bool.outbox	= true;
						data.raw.outbox		= data.json.orderedItems.map(val=>{
							const publishedDate	= new Date(val.published);
							return {
								id:val.id.replace(/users\/.*\/statuses/,"web/statuses").replace("/activity",""),
								publishedDate:publishedDate,
								published:time2str(publishedDate),
								content:val.type==="Announce"
									?"REBLOG: "+val.object
									:val.object.content.replace(/<("[^"]*"|'[^']*'|[^'">])*>/g,''),
								visibility:val.type==="Announce"
									?"boost"
									:val.cc.length===0
										?val.to.length!==0
											?val.to[0].includes("followers")?"direct"
											:"private"
										:"direct"
									:val.to.includes("https://www.w3.org/ns/activitystreams#Public")
										?"public"
										:"unlisted",
								mentions:val.object.tag
									?val.object.tag.filter(tag=>tag.type==="Mention").map(tag=>tag.name.lastIndexOf("@")!==0
										?tag.name.slice(1,tag.name.lastIndexOf("@"))
										:tag.name.slice(1)
									):false,
								inReplyTo:val.object.inReplyTo
									?val.object.inReplyTo
									:false,
								reblog:val.type==="Announce"
									?val.cc[0].slice(val.cc[0].lastIndexOf("/")+1)
									:false,
							};
						});
						console.log("Outbox Finish",performance.now()-start);
					}else if(data.json.id==="likes.json"){
						console.log("Likes Start");
						const start	= performance.now();
						data.bool.likes	= true;
						data.raw.likes	= data.json.orderedItems.map(val=>{
							const publishedDate=(val.includes("statuses/"))
								?(new Date(Number(val.slice(val.lastIndexOf("/")+1))/65536))
								:false;
							const id	= val.replace(/users\/.*\/statuses/,"web/statuses");
							return {
								id:id,
								publishedDate:publishedDate,
								published:time2str(publishedDate),
								content:"LIKE: "+val,
								visibility:"like",
								account:(val.includes("users")&&val.includes("statuses")
									?val.slice(val.indexOf("users")+6,val.indexOf("statuses")-1)
									:(val.includes("https://")&&val.indexOf("/",8)!==-1
										?"SERVER:"+val.slice(8,val.indexOf("/",8)-1)
										:(val.includes("tag:")&&val.includes(",")
											?"SERVER:"+val.slice(4,val.indexOf(",")-1)
											:val))),
							};
						});
						console.log("Likes Finish",performance.now()-start);
					}else if(data.json.id==="archive.json"){
						data.raw.outbox	= data.json.outbox;
						data.raw.likes	= data.json.likes;
					}else window.alert("You chose wrong file.");
					if(data.bool.outbox&&data.bool.likes) loadPage();
					else if(data.bool.outbox) console.log('Drop "likes.json"');
					else if(data.bool.likes) console.log('Drop "outbox.json"');
				};
				reader.readAsText(file);
			}else window.alert("You chose wrong file.");
		}
	};
	const loadPage	= ()=>{
		// RAW => FULL
		elem("progress").style.display	= "block";
		elem("dropArea").style.display	= "none";
		elem("load").style.display		= "none";
		data.full		= data.raw.outbox
			.concat(data.raw.likes)
			.sort((a,b)=>(a.publishedDate&&b.publishedDate)?(b.publishedDate-a.publishedDate):0);
		range.full		= [data.raw.outbox[0],data.raw.outbox[data.raw.outbox.length-1]].map(val=>date2str(val.publishedDate));
		const since		= new Date(range.full[0]);
		const until		= new Date(range.full[1]);
		const nmonth	= (until.getYear()-since.getYear())*12+(until.getMonth()-since.getMonth())+1;
		noUiSlider.create(elem("slider"),{
			step:1,
			margin:1,
			connect:true,
			direction:"ltr",
			orientation:"horizontal",
			behaviour:"tap-drag",
			range:{
				min:0,
				max:nmonth,
			},
			start:[0,nmonth],
			pips:{
				mode:"steps",
				values:nmonth+1,
				density:0,
				filter:(value,type)=>(value%1)?-1:0,
			},
		});
		elem("slider").noUiSlider.on("update",(values)=>{
			const since	= new Date(range.full[0]);
			const until	= new Date(range.full[0]);
			since.setDate(1);
			until.setDate(1);
			since.setMonth(since.getMonth()+Number(values[0]));
			until.setMonth(until.getMonth()+Number(values[1]));
			// until.setDate(until.getDate()-1);
			range.slider[0]	= date2str(since);
			range.slider[1]	= date2str(until);
			elem("range_since").value	= (range.slider[0]<range.full[0])?range.full[0]:range.slider[0];
			elem("range_until").value	= (range.slider[1]>range.full[1])?range.full[1]:range.slider[1];
			dataRange();
			if(plot.data==="post")			data.plot	= data.range;
			else if(plot.data==="search")	data.plot	= data.search;
			else dataRank();
		});
		elem("main").style.display		= "block";
		elem("progress").style.display	= "none";
	};
/* Summary */
	const button	= (input)=>{
		const id	= input.getAttribute("id").slice(2,);
		console.log(`button ${id}`)
		if(id==="open"){
			elem("range").style.display	= (elem("range").style.display==="none")
				?"block"
				:"none";
		}else if(id==="slider"){
			elem("slider").noUiSlider.set([0,100]);
			dataRange();
		}else if(id.includes("nge")){
			dataRange();
		}else{
			const name	= input.getAttribute("name");
			if(name==="visi"){
				plot.visibility=Array.from(document.getElementsByName("visi")).filter(val=>val.checked).map(val=>val.id.slice(2,));
				showSearch();
				if(plot.type==="bar") showBar();
				else dataReso();
			}else{
				const flag	= [name];
				plot[name]	= id;
				if(["post","search"].includes(plot.data)){
					plot.rank	= false;
					data.plot	= plot.data==="post"?data.range:data.search;
					["type","stack","reso","cumu"].forEach(val=>{
						elem(`${val}_palette`).style.display	= "block";
					});
					if(plot.type!=="line") elem("cumu_palette").style.display	= "none";
					const dict={
						bar:{
							day:["minute","minutes","hour"],
							week:["minutes","hour","hours","day"],
							month:["hour","hours","day"],
							year:["day","week","month"],
							none:["hours","day","week","month"],
						},
						line:{
							day:["minute","minutes","hour"],
							week:["minutes","hour","hours"],
							month:["hour","hours","day"],
							year:["day","week"],
						},
						calendar:{
							day:["minutes","hour","hours"],
							week:["hour","hours","day"],
							month:["hours","day","week"],
							year:["day","week","month"],
						},
						horizon:{
							day:["minute","minutes","hour"],
							week:["minutes","hour","hours"],
							month:["hour","hours","day"],
							year:["day","week"],
						},
					};
					if(!dict[plot.type][plot.stack]){
						flag.push("stack");
						elem("s_"+plot.stack).checked	= "";
						plot.stack	= plot.type==="line"
							?"year"
							:plot.type==="bar"
								?"month"
								:"week";
						elem("s_"+plot.stack).checked	= "checked";
					}
					if(!dict[plot.type][plot.stack].includes(plot.reso)){
						flag.push("reso");
						elem("r_"+plot.reso).checked	= "";
						const array	= dict[plot.type][plot.stack];
						plot.reso	= array[array.length-1];
						elem("r_"+plot.reso).checked	= "checked";
					}
					["none","day","week","month","year"].forEach(val=>{
						elem("stack_"+val).style.display	= (dict[plot.type][val])?"inline":"none";
					});
					["minute","minutes","hour","hours","day","week","month","full"].forEach(val=>{
						elem("reso_"+val).style.display		= (dict[plot.type][plot.stack].includes(val))?"inline":"none";
					});
					if(plot.type==="bar"){
						if(["reso","stack","type"].some(key=>flag.includes(key))) dataBar();
						else showBar();
					}else{
						if(["reso","visi"].some(key=>flag.includes(key))) dataReso();
						else showReso();
					}
				}else if(["mention","reblog","like"].includes(plot.data)){
					plot.rank	= true;
					["type","stack","reso","cumu"].forEach(val=>{
						elem(`${val}_palette`).style.display	= "none";
					});
					dataRank();
				}
			}
		}
		return true;
	};
	const dataRange=()=>{
		// FULL => RANGE
		console.log("dataRange");
		if(!elem("range_since").value) elem("range_since").value	= range.full[0];
		if(!elem("range_until").value) elem("range_until").value	= range.full[1];
		range.select	= ["since","until"].map(val=>new Date(elem(`range_${val}`).value));
		data.range		= data.full.filter(val=>val.publishedDate!==false&&range.select[0].getTime()<=val.publishedDate.getTime()&&val.publishedDate.getTime()<range.select[1].getTime());
		showSummary();
	};
	const showSummary=()=>{
		// RANGE
		console.log("showSummary");
		const up_count	= Array.from(new Set(data.range.filter(val=>val.visibility!=="like").map(val=>date2str(val.publishedDate)))).length;
		const days_count= (range.select[1]-range.select[0])/24/60/60/1000+1;
		const count		= {
			public:0,
			unlisted:0,
			private:0,
			direct:0,
			boost:0,
			post:0,
			mention:0,
			like:0,
		};
		data.range.forEach(val=>{
			count[val.visibility]+=1;
			if(val.visibility!="like") count.post+=1;
			if(val.mentions&&val.mentions.length>0) count.mention+=1;
		});
		count.toot	= count.post-count.boost;
		elem("db_since_until").innerHTML	= `Got <b>${count.post}</b> posts, since <b>${date2str(range.select[0])}</b> until <b>${date2str(range.select[1])}</b>.`;
		elem("up_count_ratio").innerHTML	= `You used Mastodon <b>${up_count}</b>/<b>${days_count}</b> days (<b>${(up_count/days_count*100).toFixed(1)}%</b>) and toot <b>${(count.post/up_count).toFixed()}</b> times per day.`;
		elem("visibility_ratio").innerHTML	= ["public","unlisted","private","direct","boost"]
			.map(val=>`<b>${(count[val]/count.post*100).toFixed(2)}%</b> in ${val[0].toUpperCase()}${val.slice(1)}${val==="boost"?".":", "}`)
			.join("");
		elem("posts_reply_count").innerHTML	= `Toot: <b>${count.toot}</b> times, Reply: <b>${count.mention}</b> times, Boost: <b>${count.boost}</b> times, Favourite: <b>${count.like}</b> times.`;
		dataPlot();
	};
	const dataPlot=()=>{
		// RANGE, RANK, SEARCH => PLOT
		data.plot=plot.data==="post"?data.range
			:plot.data==="search"?data.search
			:data.rank;
		if(plot.type==="bar") dataBar();
		else dataReso();
	};
	const dataSearch=(input)=>{
		// FULL => SEARCH
		console.log("dataSearch");
		elem("progress").style.display="block";
		const id			= input.getAttribute("id");
		const value			= elem(id).value;
		plot.search.id		= id;
		plot.search.value	= value;
		elem(id).value		= "";
		data.search			= (id==="word")
			?data.full.filter(val=>val.content.includes(value))
			:(id==="date")
				?data.full.filter(val=>val.published.includes(value))
				:(id==="account")
					?data.full.filter(val=>(val.mentions&&val.mentions.length>0
						?val.mentions.some(v=>v.includes(value))
						:(val.reblog
							?val.reblog.includes(value)
							:(val.account
								?val.account.includes(value)
								:false))))
					:[];
		showSearch();
	};
	const searchDate	= (input)=>{
		console.log("searchDate");
		elem("date").value=input.getAttribute("value");
		dataSearch(elem("date"));
	};
	const showSearch=()=>{
		// SEARCH
		console.log("showSearch");
		const visi		= plot.visibility;
		const range		= plot.range;
		const result	= data.search.filter(val=>visi.includes(val.visibility));
		elem("request").innerText	= result.length===0
			?`No data was found for ${plot.search.value} in ${plot.search.id}`
			:`There are ${result.length} results for ${plot.search.value} in ${plot.search.id}`;
		elem("result").innerHTML	= result.length===0
			?""
			:`<tbody>${result.sort((a,b)=>(a.publishedDate&&b.publishedDate)
					?(b.publishedDate-a.publishedDate)
					:(a.publishedDate
						?-1:
						(b.publishedDate
							?1
							:0))
				).map(val=>`<tr><th class=date><a target="_blank" onclick="searchDate(this)" value=${
					val.published.slice(0,10)}>${
					val.published}</a></th><th class=content><a target="_blank" href=${
					val.id}>${
					val.content}</a></th></tr>`
			).join("")}</tbody>`;
		elem("progress").style.display	= "none";
	};
	const dataRank=(type)=>{
		// FULL => RANK
		console.log("dataRank");
		showRank();
	};
	const showRank=()=>{
		// RANK
		console.log("showRank");
	};
	const dataBar=()=>{
		// PLOT => BAR
		console.log("dataBar");
		if(data.plot.length===0) return false;
		const start		= new Date("2022/01/01 00:00:00").getTime();
		const dateArr	= data.plot.map(val=>{
			const date	= new Date(val.publishedDate);
			return {
				date:plot.stack==="none"
					?par_date(date,plot.reso)
					:par_date(date,plot.reso)-par_date(date,plot.stack)+start,
				visi:val.visibility,
			};
		});
		data.bar	= par_array(d3.extent(dateArr.map(val=>val.date)),plot.reso)
			.map(date=>{
				return {
					date:date,
					num:date.getTime(),
					count:{
						public:0,
						unlisted:0,
						private:0,
						direct:0,
						boost:0,
						like:0,
					},
				};
			});
		let i	= 0;
		dateArr.sort((a,b)=>a.date-b.date).forEach((val)=>{
			while(data.bar[i].num<val.date) i++;
			data.bar[i].count[val.visi]++;
		});
		showBar();
	};
	const showBar=()=>{
		// data.bar
		console.log("showBar");
		const visi	= plot.visibility;
		const range	= plot.range;
		d3.select("#map").select("svg").remove();
		const height	= 600;
		const xz	= d3.range(data.bar.length);//arr.map(val=>new Date(val.date+start.getTime()));
		const keys	= data.bar[0]
			?Object.keys(data.bar[0].count)
			:[];
		const n		= keys.length;
		const yz	= keys.map(key=>data.bar.map(val=>val.count[key]));
		const y01z	=  d3.stack()
			.keys(d3.range(n))
			(d3.transpose(yz)) // stacked yz
			.map((data, i) => data.map(([y0, y1]) => [y0, y1, i]));
		const yMax	= d3.max(yz,y=>d3.max(y));
		const y1Max	= d3.max(y01z,y=>d3.max(y,d=>d[1]));
		const x		= d3.scaleBand(xz,[0,plot.width]);
		const y		= d3.scaleLinear()
			.domain([0,y1Max])
			.range([height,0]);
		const z		= d3.scaleSequential(d3.interpolateBlues)
			.domain([-0.5*n,1.5*n]);
		const svg	= d3.select("#map")
			.append("svg")
			.attr("viewBox", [0, 0, plot.width, height]);
		const rect	= svg.selectAll("g")
			.data(y01z)
			.join("g")
			.attr("fill", (d, i) => z(i))
			.selectAll("rect")
			.data(d => d)
			.join("rect")
			.attr("x", (d, i) => x(i))
			.attr("y", height)
			.attr("width", x.bandwidth())
			.attr("height", 0);
		const xAxis	= svg=>svg.append("g")
			.attr("transform",`translate(0,${height})`)
			.call(d3.axisBottom(x)
				.tickSizeOuter(0)
				.tickFormat(()=>"")
			);
		svg.append("g")
			.call(xAxis);
		y.domain([0, y1Max]);
		rect.transition()
			.duration(2000/xz.length)
			.delay((d, i) => i * 2000/xz.length)
			.attr("y", d => y(d[1]))
			.attr("height", d => y(d[0]) - y(d[1]))
		.transition()
			.attr("x", (d, i) => x(i))
			.attr("width", x.bandwidth());
		const update=()=>{};
		plot.bar	= Object.assign(svg.node(), {update});
	};
	const dataReso=()=>{
		// data.plot => data.reso
		console.log("dataReso");
		const visi	= plot.visibility;
		const reso	= plot.reso;
		const dateArr	= data.plot
			.filter(val=>visi.includes(val.visibility))
			.map(val=>par_date(new Date(val.publishedDate),reso));
		data.reso	= par_array(d3.extent(dateArr),reso).map((date,idx,arr)=>{
			return {
				date:date,
				count:0,
				day:d3.timeDay(date),
				week:d3.timeWeek(date),
				month:d3.timeMonth(date),
				year:d3.timeYear(date),
				none:arr[0],
				num:date.getTime(),
			};
		});
		let i	= 0;
		dateArr.sort().forEach((val)=>{
			while(data.reso[i].num!==val) i++;
			data.reso[i].count++;
		});
		showReso();
	};
	const showReso=()=>{
		// data.reso
		console.log("showReso");
		const type	= plot.type;
		d3.select("#map").select("svg").remove();
		if(type==="calendar") showCalendar();
		else if(type==="horizon") showHorizon();
		else if(type==="line") showLine();
	};
	const par_date	= (date,par)=>(
		(par==="minute")?d3.timeMinute(date).getTime()
		:(par==="minutes")?date.setMinutes(Math.floor(date.getMinutes()/10)*10,0,0)
		:(par==="hour")?d3.timeHour(date).getTime()
		:(par==="hours")?date.setHours(Math.floor(date.getHours()/2)*2,0,0,0)
		:(par==="day")?d3.timeDay(date).getTime()
		:(par==="week")?d3.timeWeek(date).getTime()
		:(par==="month")?d3.timeMonth(date).getTime()
		:(par==="year")?d3.timeYear(date).getTime()
		:date.getTime());
	const par_array=(dateExtent,par)=>{
		const array	= (
			(par==="minute")?d3.timeMinutes(...dateExtent)
			:(par==="minutes")?d3.timeMinutes(...dateExtent,10)
			:(par==="hour")?d3.timeHours(...dateExtent)
			:(par==="hours")?d3.timeHours(...dateExtent,2)
			:(par==="day")?d3.timeDays(...dateExtent)
			:(par==="week")?d3.timeWeeks(...dateExtent)
			:(par==="month")?d3.timeMonths(...dateExtent)
			:(par==="year")?d3.timeYears(...dateExtent)
			:[]
		);
		if(dateExtent[1]) array.push(new Date(dateExtent[1]));
		return array;
	};
	const showHorizon	= ()=>{
		console.log("showHorizon");
		d3.select("#map").select("svg").remove();
		const stack	= plot.stack;
		const x		= data.reso.map(val=>val.date-val[plot.stack]);
		const y		= data.reso.map(val=>val.count);
		const z		= data.reso.map(val=>val[plot.stack]);
		const D		= data.reso.map(val=>!isNaN(val.date)&&!isNaN(val.count));
		const xDomain	= d3.extent(x);
		const yDomain	= [0,d3.max(y)];
		const zDomain	= new d3.InternSet(z);
		const I		= d3.range(x.length).filter(i=>zDomain.has(z[i]));
		const size	= zDomain.size<20
			?1000/zDomain.size
			:50;
		const bands		= 5;
		const padding	= 1;
		const height	= zDomain.size*size;
		const xRange	= [0,plot.width];
		const yRange	= [size,size-bands*(size-padding)];
		const xType		= d3.scaleUtc;
		const yType		= d3.scaleLinear;
		const xScale	= xType(xDomain, xRange);
		const yScale	= yType(yDomain, yRange);
		const xAxis		= d3.axisTop(xScale)
			.ticks(plot.width / 80)
			.tickSizeOuter(0);
		const uid	= `O-${Math.random().toString(16).slice(2)}`;
		const curve	= d3.curveLinear;
		const area	= d3.area()
			.defined(i => D[i])
			.curve(curve)
			.x(i => xScale(x[i]))
			.y0(yScale(0))
			.y1(i => yScale(y[i]));
		const svg	= d3.select("#map")
			.append("svg")
			.attr("width", plot.width)
			.attr("height", height)
			.attr("viewBox", [0, 0, plot.width, height])
			.attr("style", "max-width: 100%; height: auto; height: intrinsic;")
			.attr("font-family", "sans-serif")
			.attr("font-size", 10);

		const g	= svg.selectAll("g")
			.data(d3.group(I, i => z[i]))
			.join("g")
			.attr("transform", (_, i) => `translate(0,${i*size})`);

		const defs	= g.append("defs");

		defs.append("clipPath")
			.attr("id", (_, i) => `${uid}-clip-${i}`)
			.append("rect")
			.attr("y", padding)
			.attr("width", plot.width)
			.attr("height", size - padding);

		defs.append("path")
			.attr("id", (_, i) => `${uid}-path-${i}`)
			.attr("d", ([, I]) => area(I));
		const scheme	= d3.schemeBlues;
		const colors	= scheme[Math.max(3,bands)];
		g
			.attr("clip-path", (_, i) => `url(${new URL(`#${uid}-clip-${i}`, location)})`)
			.selectAll("use")
			.data((d, i) => new Array(bands).fill(i))
			.join("use")
			.attr("fill", (_, i) => colors[i + Math.max(0, 3 - bands)])
			.attr("transform", (_, i) => `translate(0,${i * size})`)
			.attr("xlink:href", (i) => `${new URL(`#${uid}-path-${i}`, location)}`);

		g.append("text")
			.attr("x",0)
			.attr("y", (size + padding) / 2)
			.attr("dy", "0.35em")
			.text(([z]) => date2str(z));
		svg.append("g")
			.attr("transform", `translate(0,0)`)
			.call(xAxis)
			.call(g => g.selectAll(".tick")
				.filter(d => xScale(d) < 10 || xScale(d) > plot.width - 10)
				.remove())
			.call(g => g.select(".domain").remove());
		return svg.node();
	};
	const showCalendar	= ()=>{
		console.log("showCalendar");
		d3.select("#map").select("svg").remove();
		const stack	= plot.stack;
		const xStep	= Math.min(...Array.from(
			new Set(
				data.reso
					.map(val=>val.date)
					.map((val,idx,arr)=>arr[idx+1]-val)
					.filter(val=>!isNaN(val))
			)
		));
		data.reso.forEach(val=>{
			val.x	= (val.date-val[plot.stack])/xStep;
			val.y	= val[plot.stack];
		});
		const xMax		= Math.max(...new Set(data.reso.map(val=>val.x)));
		const nwidth	= Math.ceil(xMax)+1;
		const xArr		= d3.range(nwidth);
		const yExtent	= d3.extent(data.reso,d=>d.y);
		const yArr		= par_array(yExtent,plot.stack);
		const nheight	= yArr.length;
		const size		= (
			nheight>1000?1
			:nheight>100?1000/nheight
			:nheight>50?10
			:500/nheight
			);
		const height	= nheight*size;
		const x			= d3.scaleBand(xArr,[0,plot.width]).round(true);
		const y			= d3.scaleBand(yArr,[0,height]).round(true);
		const formatY	= date=>(nheight>100)
			?plot.stack=="week"
				?date.getDate()<8
					?date2str(date)
					:""
				:date.getDate()===1
					?date2str(date)
					:""
			:nheight>50
				?date.getDay()===0
					?date2str(date)
					:""
				:date2str(date);
		const color	= d3.scaleSequential([0,Math.max(...data.reso.map(val=>val.count))],d3.interpolateReds);
		const svg	= d3.select("#map")
			.append("svg")
			.attr("viewBox",[0,0,plot.width,height])
			.style("background","white");
		const rect	= svg.append("g")
			.selectAll("rect")
			.data(data.reso.filter(val=>val.count>0))
			.join("rect")
				.attr("x",d=>x(Math.floor(d.x)))      
				.attr("y",d=>y(d.y))
				.attr("width",x.bandwidth()-1)
				.attr("height",y.bandwidth()>1?y.bandwidth()-1:1)
				.attr("fill",d=>color(d.count))
			.append("text")
                .attr("font-family","sans-serif")
                .attr("font-size",10)
                .attr("text-anchor","middle")
                .attr("y",-8)
			.append("title")
				.text(d=>`${time2str(d.date)}: ${d.count}`);
		const xline	= svg.append("line")
			.attr("x1",-1)
			.attr("y1", 0)
			.attr("x2",-1)
			.attr("y2", height)
			.attr("stroke", "#000");
		const yline	= svg.append("line")
			.attr("x1", 0)
			.attr("y1",-1)
			.attr("x2", plot.width)
			.attr("y2",-1)
			.attr("stroke", "#000");
		const tSize	= (size>1?(size+1):size)/2;
		svg.append("g")
			.selectAll("rect")
			.data(yArr)
			.join("text")
				.attr("x",0)
				.attr("y",d=>y(d)+tSize)
				.attr("dy","0.35em")
				.text(d=>formatY(d));
		const voronoi	= d3.Delaunay.from(data.reso
			.filter(val=>val.count>0)
			.map(d=>[x(Math.floor(d.x))+x.bandwidth()/2,y(d.y)+tSize])
		).voronoi([0,0,plot.width,height]);
		const mouseovered	= (event, d)=>{
			const x0	= x(Math.floor(d.x))+x.bandwidth()/2;
			const y0	= y(d.y)+tSize;
			xline.attr("x1",x0).attr("x2",x0);
			yline.attr("y1",y0).attr("y2",y0);
		};
		const mouseouted	= (event, d)=>{
			xline.attr("x1",-1).attr("x2",-1);
			yline.attr("y1",-1).attr("y2",-1);
		};
		svg.append("g")
			.attr("pointer-events", "all")
			.attr("fill", "none")
			.selectAll("path")
			.data(data.reso.filter(val=>val.count>0))
			.join("path")
			.on("mouseover", mouseovered)
			.on("mouseout", mouseouted)
			.attr("d", (d, i) => voronoi.renderCell(i))
			.append("title")
			.text(d=>`${time2str(d.date)}: ${d.count}`);
		return svg.node();
	};
	const showLine	= ()=>{
		console.log("showLine");
		d3.select("#map").select("svg").remove();
		const height	= 720;
		const dashTween	= ()=>{
			const length	= this.getTotalLength();
			return d3.interpolate(`0,${length}`, `${length},${length}`);
		};
		const intrayear	= (date)=>{
			date	= new Date(+date);
			date.setUTCFullYear(2000);
			return date;
		};
		const x		= d3.scaleUtc([Date.UTC(2000,0,1),Date.UTC(2001,0,0)],[0,plot.width]);
		const y		= d3.scaleLinear([0, d3.max(data, d => d.value)], [height,0]);
		const z		= d3.scaleSequential(d3.extent(data, d => d.date.getUTCFullYear()), t => d3.interpolateSpectral(1 - t));
		const svg	= d3.select("#map")
			.append("svg")
			.attr("viewBox", [0,0,plot.width,height]);
		const xAxis	= g => g
			.attr("transform", `translate(0,${height})`)
			.call(d3.axisBottom(x)
				.ticks(plot.width/80,"%B")
				.tickSizeOuter(0));
		const yAxis	= g => g
			.attr("transform", `translate(0,0)`)
			.call(d3.axisLeft(y).ticks(null, "s"))
			.call(g => g.select(".domain").remove())
			.call(g => g.selectAll(".tick:not(:first-of-type) line").clone()
				.attr("x2", plot.width)
				.attr("stroke", "#ddd"))
			.call(g => g.select(".tick:last-of-type text").clone()
				.attr("x", 3)
				.attr("text-anchor", "start")
				.attr("font-weight", "bold")
				.text(data.y));
		svg.append("g")
			.call(xAxis);
		svg.append("g")
			.call(yAxis);
		const line	= d3.line()
			.defined(d => !isNaN(d.value))
			.x(d => x(intrayear(d.date)))
			.y(d => y(d.value));
		const g	= svg.append("g")
			.attr("font-family", "sans-serif")
			.attr("font-size", 10)
			.attr("fill", "none")
			.attr("stroke-width", 1.5)
			.attr("stroke-miterlimit", 1);
		// for (const [key, values] of d3.group(data, d => d.date.getUTCFullYear())) {
		// 	yield svg.node();
		// 	await g.append("path")
		// 		.attr("d", line(values))
		// 		.attr("stroke", z(key))
		// 		.attr("stroke-dasharray", "0,1")
		// 	.transition()
		// 		.ease(d3.easeLinear)
		// 		.attrTween("stroke-dasharray", dashTween)
		// 	.end();

		// 	if (!isNaN(values[values.length - 1].value)) {
		// 	g.append("text")
		// 		.attr("stroke", "white")
		// 		.attr("stroke-width", 3)
		// 		.attr("dx", 4)
		// 		.attr("dy", "0.32em")
		// 		.attr("x", x(intrayear(values[values.length - 1].date)))
		// 		.attr("y", y(values[values.length - 1].value))
		// 		.text(key)
		// 		.clone(true)
		// 		.attr("fill", z(key))
		// 		.attr("stroke", "none");
		// 	}
		// }
	};
/* Database */
	const db={
		ver:1,
		name:"mastodon",
		store:"archive",
		id:1,
		database:null,
		indexedDB:(		window.indexedDB 		|| window.webkitIndexedDB		|| window.mozIndexedDB),
		transaction:(	window.IDBTransaction	|| window.webkitIDBTransaction	|| window.mozIDBTransaction),
	};
	const createSample		= ()=>{
		const openRequest	= db.indexedDB.open(db.name,db.ver);
		openRequest.onupgradeneeded	= (e)=>{
			console.log("create-upgradeneeded");
			db.database	= openRequest.result;
			db.database.createObjectStore(db.store, { "keyPath": "id" });
			console.log(db.database.objectStoreNames);
		};
		openRequest.onsuccess	= (e)=>{
			db.database	= openRequest.result;
			const addRequest	= db.database.transaction(db.store, "readwrite").objectStore(db.store).put({
				id:db.id,
				outbox:data.raw.outbox,
				likes:data.raw.likes,
			});
			addRequest.onsuccess=()=>{
				console.log("Success");
				elem("createSample").style.display="none";
				elem("deleteSample").style.display="table-row";
			};
			addRequest.onerror=(e)=>{console.log(e.message)};
		};
		openRequest.onerror	= function(err){console.log(err.message)}
		openRequest.onblocked=function(err){console.log("blocked")}
	};
	const getSample=()=>{
		const openRequest=db.indexedDB.open(db.name,db.ver);
		db.database=null;
		openRequest.onsuccess=(e)=>{
			db.database=openRequest.result;
			if(db.database.objectStoreNames.length>0){
				const transaction=db.database.transaction([db.store], db.transaction.READ_ONLY);
				const getRequest=transaction.objectStore(db.store).get(db.id);
				getRequest.onsuccess=(e)=>{
					data.raw.outbox=getRequest.result.outbox;
					data.raw.likes=getRequest.result.likes;
					if(data.raw.outbox&&data.raw.likes){
						loadPage();
						elem("createSample").style.display="none";
						elem("deleteSample").style.display="table-row";
					}
					else console.log("Not Found");
				}
				getRequest.onerror=(e)=>{console.log(e)}
			}else{
				console.log("db none");
				db.database.close();
				deleteSample();
			}
		}
		openRequest.onerror=(e)=>{console.log(e)}
	};
	const deleteSample=()=>{
		if(db.database) db.database.close();
		const deleteRequest	= db.indexedDB.deleteDatabase(db.name);
		deleteRequest.onsuccess=(e)=>{
			console.log("Deleted in Successful");
			elem("createSample").style.display="table-row";
			elem("deleteSample").style.display="none";
		};
		deleteRequest.onerror=(e)=>{console.log(e.message)};
		deleteRequest.onblocked=(e)=>{console.log("There is a severe error, I hope you don't get this message.")};
	};
	const downloadJson=()=>{
		if(data.raw.outbox&&data.raw.likes){
			const downloadLink=elem("downloadLink");
			const blob=new Blob([JSON.stringify({
				id:"archive.json",
				outbox:data.raw.outbox,
				likes:data.raw.likes,
			})],{type:"application/json"});
			downloadLink.href=URL.createObjectURL(blob);
			downloadLink.download="mastodonArchiveViewer.json";
			downloadLink.click();
		}
	};
		</script>
	</body>
</html>